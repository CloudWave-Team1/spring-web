<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Messages</title>
    <style>
        /* 테이블에 테두리 추가 */
        table {
            border-collapse: collapse; /* 테두리가 겹치도록 설정 */
            width: 100%;
        }

        /* 테이블의 셀마다 테두리 추가 */
        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 10px; /* 셀 내부의 패딩 추가 */
        }

        .hidden-receiptHandle {
            display: none;
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById('checkBoxForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const checkboxes = document.querySelectorAll('.orderCheckbox');
                let selectedOrders = [];

                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        const [receiptHandle, customerId] = checkbox.value.split('|');
                        selectedOrders.push({ receiptHandle, customerId });
                    }
                });

                // 선택된 체크박스가 없으면 알림을 보여줍니다.
                if (selectedOrders.length === 0) {
                    alert('Please select at least one checkbox.');
                    return;
                }

                // 선택된 각 체크박스에 대해 AJAX 요청을 전송합니다.
                selectedOrders.forEach(order => {
                    const data = {
                        receiptHandle: order.receiptHandle
                    };

                    fetch(`/api/messages/completeAndNotify?customerId=${order.customerId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    }).then(response => {
                        if (response.status === 200) {
                            return response.json();
                        } else {
                            throw new Error('Failed to process transaction');
                        }
                    }).then(responseData => {
                        alert("[" + responseData.snsMessageId + "] " + responseData.message);
                        location.replace(location.href);
                    }).catch(error => {
                        alert(error.message);
                    });
                });
            });
        });
    </script>

</head>
<body>

<h2>Message List</h2>

<form id="checkBoxForm" action="/yourControllerPath" method="post">
    <table>
        <thead>
        <tr>
            <th>Select</th>
            <th>Order ID</th>
            <th>Food Item</th>
            <th>Quantity</th>
            <th>Order Date</th>
            <th class="hidden-receiptHandle">receiptHandle</th>
            <th class="hidden-receiptHandle">customerId</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="order : ${orders}">
            <td><input type="checkbox" class="orderCheckbox" th:value="${order.receiptHandle} + '|' + ${order.customerId}" name="receiptHandles"/></td>
            <td th:text="${order.orderId}"></td>
            <td th:text="${order.foodItem}"></td>
            <td th:text="${order.quantity}"></td>
            <td th:text="${order.orderDate}"></td>
            <td class="hidden-receiptHandle" th:text="${order.receiptHandle}"></td>
            <td class="hidden-receiptHandle" th:text="${order.customerId}"></td>
        </tr>
        </tbody>
    </table>
    <button type="submit">Submit Selected</button>
</form>

</body>
</html>